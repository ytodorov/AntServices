
<input type="button" id="btnDownload" class="k-button" value="Download" />
<input type="button" id="btnUpload" class="k-button" value="Upload" />

<input type="number" id="tbDownloadLength" />
<input type="text" id="tbDownloadResult" class="k-textbox" />

<div id="result"></div>

@section scripts {
    <script>
        function CreateRandomString(char) {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

            for (var i = 0; i < char; i++)
                text += possible.charAt(Math.floor(Math.random() * possible.length));

            return text;
        }

        $(document).ready(function () {
            $("#tbDownloadLength").kendoNumericTextBox({
               
            });

            $("#btnDownload").click(function btnDownloadClick() {
                var numerictextbox = $("#tbDownloadLength").data("kendoNumericTextBox");
                // use markes so performance.getEntriesByName is unique
                $("#result").append("downloadStart" + '<br />');
                for (var i = 0; i < 6; i++) {
                    $("#result").append("downloadStart" + i + '<br />');
                    var currentDownloadLength = Math.pow(10, i);    // 49
                    // 10 ^ 7 = 10 MB
                    var marker = new Date().getTime();

                    var downloadLength = numerictextbox.value();
                    $.ajax({
                        async: true,
                        AcceptEncoding: "text/plain",
                        url: "/speedtest/download?downloadLength=" + acurrentDownloadLength + "&marker=" + marker,
                        cache: false
                    })
                     .fail(function () {
                         alert("error");
                     })
                      .done(function (html) {

                          var performanceLastRequest = performance.getEntriesByName(location.origin + this.url);
                          var timeInMilliseconds = performanceLastRequest[0].responseEnd - performanceLastRequest[0].responseStart;
                          $("#result").append(timeInMilliseconds + ' download of ' + currentDownloadLength + '<br />');
                      });

                }

               
            });



            $("#btnUpload").click(function btnUploadClick() {
                $("#result").append("uploadStart" + '<br />');

                var numerictextbox = $("#tbDownloadLength").data("kendoNumericTextBox");

                
                for (var i = 0; i < 6; i++) {
                    $("#result").append("uploadStart" + i + '<br />');
                    var currentDownloadLength = Math.pow(10, i);    // 49

                    // use markes so performance.getEntriesByName is unique
                    var marker = new Date().getTime();


                    var uploadString = CreateRandomString(currentDownloadLength);
                    $.ajax({
                        async: true,
                        method: "POST",
                        AcceptEncoding: "text/plain",
                        url: "/speedtest/upload?marker=" + marker,
                        data: { uploadString: uploadString },
                        cache: false
                    })
                         .fail(function () {
                             alert("error");
                         })
                      .done(function (html) {

                          var performanceLastRequest = performance.getEntriesByName(location.origin + this.url);
                          var timeInMilliseconds = performanceLastRequest[0].responseStart - performanceLastRequest[0].requestStart;
                          $("#result").append(timeInMilliseconds + ' upload of ' + currentDownloadLength + '<br />');
                      });
                }
            })

        });

    </script>
}
