
<input type="button" id="btnDownload" class="k-button" value="Download" />
<input type="button" id="btnUpload" class="k-button" value="Upload" />

<input type="number" id="tbDownloadLength" />
<input type="text" id="tbDownloadResult" class="k-textbox" />

<div id="result"></div>

@section scripts {
    <script>

        alert(performance.now());
        alert(performance.timing);
        alert(performance.timing.connectEnd);

        function CreateRandomString(char) {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

            for (var i = 0; i < char; i++)
                text += possible.charAt(Math.floor(Math.random() * possible.length));

            return text;
        }

        $(document).ready(function () {
            $("#tbDownloadLength").kendoNumericTextBox({
               
            });

            $("#btnDownload").click(function btnDownloadClick() {
                var numerictextbox = $("#tbDownloadLength").data("kendoNumericTextBox");
                // use markes so performance.getEntriesByName is unique
                $("#result").append("downloadStart" + '<br />');
                for (var i = 3; i < 7; i++) {
                    $("#result").append("downloadStart" + i + '<br />');
                    var currentDownloadLength = Math.pow(10, i);    // 49
                    // 10 ^ 7 = 10 MB
                    var marker = new Date().getTime();

                    var downloadLength = numerictextbox.value();
                    $.ajax({
                        async: false,
                        url: "/speedtest/download?downloadLength=" + currentDownloadLength + "&marker=" + marker,
                        success: function f(stringWithTicks) {
                           
                            
                            //var n = stringWithTicks.indexOf("_ticks_");
                            //var ticksAsString = stringWithTicks.substring(n + "_ticks_".length);
                            //var ticksInt = parseInt(ticksAsString);
                            //var tickNow = ((new Date().getTime() * 10000) + 621355968000000000);

                            //var diff = tickNow - ticksInt;
                            //var myDate = new Date(diff);

                            //$("#result").append(' download of ' + currentDownloadLength + '<br />');
                            var performanceLastRequest = performance.getEntriesByName(location.origin + this.url);
                            var timeInMilliseconds = performanceLastRequest[0].responseEnd - performanceLastRequest[0].responseStart;
                            $("#result").append(timeInMilliseconds + ' download of ' + currentDownloadLength + '<br />');
                        }
                    })
                }

               
            });



            $("#btnUpload").click(function btnUploadClick() {
                $("#result").append("uploadStart" + '<br />');

                var numerictextbox = $("#tbDownloadLength").data("kendoNumericTextBox");

                
                for (var i = 3; i < 7; i++) {
                    $("#result").append("uploadStart" + i + '<br />');
                    var currentDownloadLength = Math.pow(10, i);    // 49

                    // use markes so performance.getEntriesByName is unique
                    var marker = new Date().getTime();


                    var uploadString = CreateRandomString(currentDownloadLength);
                    $.ajax({
                        async: false,
                        method: "POST",
                        url: "/speedtest/upload?marker=" + marker,
                        data: { uploadString: uploadString },
                        success: function f(id) {
                            //$("#result").append(' upload of ' + currentDownloadLength + '<br />');
                            var performanceLastRequest = performance.getEntriesByName(location.origin + this.url);
                            var timeInMilliseconds = performanceLastRequest[0].responseStart - performanceLastRequest[0].requestStart;
                            $("#result").append(timeInMilliseconds + ' upload of ' + currentDownloadLength + '<br />');
                        }
                    });
                }
            })

        });

    </script>
}
